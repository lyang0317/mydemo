var pageSize=5,currPage=1;$(function(){getAllAdmins();});function getAllAdmins(b){if(b){currPage=b;}var a=$("#J_adminTbody");$.ajax({url:AJAXURL.getAllAdmins,data:{currentPage:currPage,pageSize:pageSize},type:"POST",dataType:"JSON",beforeSend:function(){a.html('<tr><td colspan="4"><i class="load-one">拼命加载中...</i></td></tr>');
},success:function(d){if(d.state){var c=d.data;a.html(createAdminListHtml(c.list));new PAGE("J_comPage",currPage,c.totalPage,getAllAdmins);getAllService();
}else{a.html('<tr><td colspan="4">数据异常，请稍后<a href="javascript:;" onclick="location.reload();return false;">重试</a></td></tr>');}},error:function(){a.html('<tr><td colspan="4">链接异常，请稍后<a href="javascript:;" onclick="location.reload();return false;">重试</a></td></tr>');
}});}function createAdminListHtml(e){var d=[],a=e.length;if(a>0){for(var c=0;c<a;c++){var b=createAdminListServiceHtml(e[c].services);d.push("<tr>");d.push("<td>"+e[c].realname+"</td>");
d.push("<td>"+e[c].email+"</td>");d.push("<td>"+b.html+"</td>");d.push('<td><a title="修改服务" data-toggle="modal" data-target="#updateService" onclick="showUpdateServModal(\''+b.ids+"',"+e[c].adminid+');">修改服务</a>  |  <a class="del" data-toggle="modal" data-target="#delAdmin" onclick="delAdmin('+e[c].adminid+');return false;" title="删除">删除</a></td>');
d.push("</tr>");}}else{d.push('<tr><td colspan="4">暂无数据</tr>');$("#J_comPage").html("");}return d.join("");}function createAdminListServiceHtml(f){var d={},c=[],e=[];
if(f!=null){var a=f.length;for(var b=0;b<a;b++){c.push('<p class="serv-name">'+f[b].servicename+"</p>");e.push(f[b].serviceid);}d.html=c.join("");d.ids=e.join("-");
}else{d.html="";d.ids="";}return d;}function getAllService(){var a=$("#J_adminServList");$.ajax({url:AJAXURL.getRoles,type:"POST",dataType:"JSON",beforeSend:function(){a.html('<i class="load-one">拼命加载中...</i>');
},success:function(b){if(b.state){var c=b.data;a.html(createServListHtml(c));servCHeckboxClick();}else{a.html('数据异常，请稍后<a href="javascript:;" onclick="location.reload();return false;">重试</a>');
}},error:function(){a.html('链接异常，请稍后<a href="javascript:;" onclick="location.reload();return false;">重试</a>');}});}function createServListHtml(d){var c=[],a=d.length;
for(var b=0;b<a;b++){c.push('<label class="checkbox-inline" title="'+d[b].servicename+'">');c.push('<input id="J_adminServId_'+d[b].roleid+'" type="checkbox" value="'+d[b].roleid+'">');
c.push("<span>"+d[b].servicename+"</span>");c.push("</label>");}return c.join("");}function showUpdateServModal(e,d){$("#J_adminServList input").attr("checked",false);
if(e!=""){var c=e.split("-"),a=c.length;for(var b=0;b<a;b++){document.getElementById("J_adminServId_"+c[b]).checked=true;}}$("#updateService").on("show.bs.modal",function(f){$("#J_adminUpDateSubmit").on("click",function(){var g=serviceidArr.length;
if(g>0){$.ajax({url:AJAXURL.modifyRole,data:{serviceid:JSON.stringify(serviceidArr),adminid:d},type:"POST",dataType:"JSON",success:function(h){if(h.state){alert("修改成功！确定后将刷新页面！");
location.reload();}else{alert("数据异常，请稍后再试！");}}});}else{alert("请选择或者取消服务");}});});}var serviceidArr=[];function servCHeckboxClick(){var b=$("#J_adminServList input"),a=b.length;
for(var c=0;c<a;c++){b[c]._i=c;b[c].onclick=function(){var d={},e=this.value,f=serviceidArrFilter(e);if(f!=null){serviceidArr.splice(f,1);}else{d.serviceid=e;
if(this.checked){d.der=1;}else{d.der=0;}serviceidArr.push(d);}};}}function serviceidArrFilter(c){var a=serviceidArr.length,d=null;if(a>0){for(var b=0;b<a;
b++){if(serviceidArr[b].serviceid==c){d=b;break;}}}return d;}function delAdmin(a){new vfCode("J_vfCodeImg","J_vfCodeChange","delAdmin");$("#J_submitDelAdmin").on("click",function(){var b=$.trim($("#J_adDelAdminYzm").val());
if(!RE.NULL.test(b)){alert("请输入验证码");return false;}if(!/^[a-zA-Z0-9]{6}$/.test(b)){alert("验证码不正确");return false;}$.ajax({url:AJAXURL.delAdmin,data:{adminid:a,input:b,captcha:"delAdmin"},type:"POST",dataType:"JSON",success:function(c){if(c.state){location.reload();
}else{if(c.msg==null){alert("数据异常，请稍后再试！");new vfCode("J_vfCodeImg","J_vfCodeChange","delAdmin");}else{alert(c.msg);new vfCode("J_vfCodeImg","J_vfCodeChange","delAdmin");
}}}});});}var addAdRealName=$("#J_addAdRealName"),addAdEmail=$("#J_addAdEmail"),addAdPwd=$("#J_addAdPwd"),addAdRealNameError=addAdRealName.find(".error"),addAdEmailError=addAdEmail.find(".error"),addAdPwdError=addAdPwd.find(".error");
var INFO={REALNAME:{FOCUS:function(){addAdRealName.removeClass("has-error");addAdRealNameError.addClass("none");},BLUR:function(b){var a=$.trim(b);if(!RE.NULL.test(a)){return false;
}if(!/^(\w+|[\u4E00-\u9FA5]){2,10}$/.test(a)){addAdRealName.addClass("has-error");addAdRealNameError.removeClass("none").html("真实姓名由2到10个字组成");return false;
}}},EMAIL:{FOCUS:function(){addAdEmail.removeClass("has-error");addAdEmailError.addClass("none");},BLUR:function(b){var a=$.trim(b);if(!RE.NULL.test(a)){return false;
}if(!RE.EMAIL.test(a)){addAdEmail.addClass("has-error");addAdEmailError.removeClass("none").html("邮箱格式不正确");return false;}}},PWD:{FOCUS:function(){addAdPwd.removeClass("has-error");
addAdPwdError.addClass("none");},BLUR:function(b){var a=$.trim(b);if(!RE.NULL.test(a)){return false;}}}};function addAdmin(){var a=addAdRealName.find(".ipt").val(),c=addAdEmail.find(".ipt").val(),b=addAdPwd.find(".pwd-ipt").val();
if(!RE.NULL.test(a)){addAdRealName.addClass("has-error");addAdRealNameError.removeClass("none").html("请输入真实姓名");return false;}else{if(!/^(\w+|[\u4E00-\u9FA5]){2,10}$/.test(a)){addAdEmail.addClass("has-error");
addAdRealNameError.removeClass("none").html("真实姓名由2到10个字组成");return false;}}if(!RE.NULL.test(c)){addAdEmail.addClass("has-error");addAdEmailError.removeClass("none").html("请输入用户邮箱");
return false;}else{if(!RE.EMAIL.test(c)){addAdEmail.addClass("has-error");addAdEmailError.removeClass("none").html("邮箱格式不正确");return false;}}if(!RE.NULL.test(b)){addAdPwd.addClass("has-error");
addAdPwdError.removeClass("none").html("请生成初始密码");return false;}$.ajax({url:AJAXURL.addAdmin,data:{realname:a,email:c,pwd:b},type:"POST",dataType:"JSON",success:function(d){if(d.state){alert("管理员添加成功!确定后将刷新页面！");
location.reload();}else{alert("数据异常，请稍后再试！");}}});}function getStartPwd(){addAdPwd.removeClass("has-error");addAdPwdError.addClass("none").html("请生成初始密码");
$.ajax({url:AJAXURL.getRandomPwd,type:"POST",dataType:"JSON",success:function(a){if(a.state){addAdPwd.find(".pwd-ipt").val(a.data);}else{alert("数据异常，请稍后再试！");
}}});}